// app/api/checkout/route.ts - ‚úÖ SIMPLIFICADO PARA SCHEMA ACTUAL
import { NextRequest, NextResponse } from 'next/server'
import { MercadoPagoConfig, Preference } from 'mercadopago'
import { z } from 'zod'
import { prisma } from '@/lib/prisma'

// ============================================================================
// CONFIGURACI√ìN
// ============================================================================

const ALLOWED_MERCADOPAGO_DOMAINS = [
  'mercadopago.com.ar',
  'mercadopago.com',
  'www.mercadopago.com.ar',
  'www.mercadopago.com'
]

const MAX_REQUESTS_PER_HOUR = 100
const FREE_SHIPPING_THRESHOLD = 500000
const STANDARD_SHIPPING_COST = 5000

const requestCounts = new Map<string, { count: number; resetTime: number }>()

if (!process.env.MERCADOPAGO_ACCESS_TOKEN) {
  console.warn('‚ö†Ô∏è MERCADOPAGO_ACCESS_TOKEN no configurado')
}

const client = process.env.MERCADOPAGO_ACCESS_TOKEN
  ? new MercadoPagoConfig({
      accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN,
      options: { timeout: 10000 }
    })
  : null

const preference = client ? new Preference(client) : null

// ============================================================================
// ZOD SCHEMAS
// ============================================================================

const ItemSchema = z.object({
  id: z.string().min(1),
  productId: z.string().min(1),
  name: z.string().min(1).max(500),
  size: z.string().optional(),
  variant: z.string().optional(),
  price: z.number().positive().finite(),
  quantity: z.number().int().positive().max(100),
  image: z.string().optional()
})

const CouponSchema = z.object({
  code: z.string().min(1).max(50),
  type: z.enum(['percentage', 'fixed']),
  discount: z.number().positive()
}).optional()

const ShippingAddressSchema = z.object({
  name: z.string().min(2).max(100).optional(),
  lastName: z.string().min(2).max(100).optional(),
  firstName: z.string().min(2).max(100).optional(),
  address: z.string().min(3).max(500).optional(),
  addressNumber: z.string().max(20).optional(),
  city: z.string().min(2).max(100).optional(),
  postalCode: z.string().min(4).max(10).optional(),
  province: z.string().min(2).max(100).optional(),
  phone: z.string().min(10).max(20).optional()
}).optional()

const CheckoutRequestSchema = z.object({
  items: z.array(ItemSchema).min(1).max(50),
  userId: z.string().optional(),
  userEmail: z.string().email(),
  coupon: CouponSchema,
  shippingAddress: ShippingAddressSchema,
  paymentMethod: z.enum(['mercadopago', 'efectivo_domicilio']).default('mercadopago'),
  paymentPlan: z.string().max(50).optional()
})

// ============================================================================
// UTILIDADES
// ============================================================================

function checkRateLimit(identifier: string): { allowed: boolean; resetIn?: number } {
  const now = Date.now()
  const record = requestCounts.get(identifier)
  
  if (!record || now > record.resetTime) {
    requestCounts.set(identifier, {
      count: 1,
      resetTime: now + 3600000
    })
    return { allowed: true }
  }
  
  if (record.count >= MAX_REQUESTS_PER_HOUR) {
    return {
      allowed: false,
      resetIn: Math.ceil((record.resetTime - now) / 1000)
    }
  }
  
  record.count++
  return { allowed: true }
}

function isValidMercadoPagoUrl(url: string): boolean {
  try {
    const parsed = new URL(url)
    return ALLOWED_MERCADOPAGO_DOMAINS.some(domain =>
      parsed.hostname === domain || parsed.hostname.endsWith(`.${domain}`)
    )
  } catch {
    return false
  }
}

function calculateTotals(items: any[], coupon?: any) {
  const subtotal = items.reduce((sum, item) => 
    sum + (item.price * item.quantity), 0
  )
  
  let discount = 0
  if (coupon) {
    if (coupon.type === 'percentage') {
      discount = Math.round((subtotal * coupon.discount) / 100)
    } else if (coupon.type === 'fixed') {
      discount = coupon.discount
    }
  }
  
  const shipping = subtotal >= FREE_SHIPPING_THRESHOLD ? 0 : STANDARD_SHIPPING_COST
  const total = subtotal - discount + shipping
  
  return { subtotal, discount, shipping, total }
}

// ============================================================================
// POST ENDPOINT
// ============================================================================

export async function POST(request: NextRequest) {
  const startTime = Date.now()
  
  try {
    if (!preference) {
      return NextResponse.json(
        { error: 'Sistema de pago no configurado. Contact√° a soporte.' },
        { status: 503 }
      )
    }
    
    const ip = request.headers.get('x-forwarded-for')?.split(',')[0].trim() ||
                request.headers.get('x-real-ip') ||
                'unknown'
    
    const rateLimit = checkRateLimit(ip)
    if (!rateLimit.allowed) {
      return NextResponse.json(
        { 
          error: 'Demasiadas solicitudes. Intent√° de nuevo m√°s tarde.',
          resetIn: rateLimit.resetIn
        },
        { 
          status: 429,
          headers: {
            'Retry-After': rateLimit.resetIn?.toString() || '3600',
            'X-RateLimit-Limit': MAX_REQUESTS_PER_HOUR.toString()
          }
        }
      )
    }
    
    const body = await request.json()
    const validatedData = CheckoutRequestSchema.parse(body)
    
    const { items, userId, userEmail, coupon, shippingAddress, paymentMethod } = validatedData
    
    console.log('üõí Creando orden:', {
      itemCount: items.length,
      userId,
      userEmail,
      paymentMethod
    })
    
    const { subtotal, discount, shipping, total } = calculateTotals(items, coupon)
    
    // ‚úÖ SIMPLIFICADO: Solo los campos que existen en el schema
    const fullAddress = shippingAddress?.address && shippingAddress?.addressNumber
      ? `${shippingAddress.address} ${shippingAddress.addressNumber}, ${shippingAddress.city || ''}, ${shippingAddress.province || ''} ${shippingAddress.postalCode || ''}`
      : shippingAddress?.address || ''
    
    const order = await prisma.order.create({
      data: {
        customerName: shippingAddress?.firstName && shippingAddress?.lastName
          ? `${shippingAddress.firstName} ${shippingAddress.lastName}`
          : shippingAddress?.name || 'Cliente',
        customerEmail: userEmail,
        customerPhone: shippingAddress?.phone || '',
        
        // ‚úÖ Todo en un solo campo shippingAddress
        shippingAddress: fullAddress,
        
        paymentMethod: paymentMethod || 'mercadopago',
        paymentStatus: 'pending',
        
        subtotal,
        shipping,
        discount,
        total,
        
        status: 'pending',
        
        items: {
          create: items.map(item => ({
            productId: item.productId,
            productName: item.name,
            variantSize: item.size || null,
            quantity: item.quantity,
            price: Math.round(item.price * 100),
            subtotal: Math.round(item.price * item.quantity * 100)
          }))
        }
      },
      include: { items: true }
    })
    
    console.log('‚úÖ Orden creada:', order.id)
    
    // SI ES EFECTIVO
    if (paymentMethod === 'efectivo_domicilio') {
      const efectivoDiscount = Math.round(total * 0.15)
      const finalTotal = total - efectivoDiscount
      
      await prisma.order.update({
        where: { id: order.id },
        data: {
          discount: discount + efectivoDiscount,
          total: finalTotal,
          status: 'confirmed'
        }
      })
      
      return NextResponse.json({
        success: true,
        orderId: order.id,
        message: 'Pedido confirmado. Te contactaremos pronto.',
        discount: efectivoDiscount,
        finalTotal,
        paymentMethod: 'efectivo_domicilio'
      })
    }
    
    // MERCADOPAGO
    const mpItems = items.map(item => ({
      id: item.productId,
      title: item.name.substring(0, 256),
      description: `${item.size || ''}${item.variant ? ` - ${item.variant}` : ''}`.substring(0, 256),
      picture_url: item.image?.startsWith('http')
        ? item.image
        : item.image?.startsWith('/')
          ? `${process.env.NEXT_PUBLIC_SITE_URL}${item.image}`
          : undefined,
      category_id: 'home',
      quantity: item.quantity,
      unit_price: item.price,
      currency_id: 'ARS' as const
    }))
    
    if (shipping > 0) {
      mpItems.push({
        id: 'shipping',
        title: 'Env√≠o a domicilio',
        description: 'Entrega en 3-6 d√≠as h√°biles',
        category_id: 'shipping',
        quantity: 1,
        unit_price: shipping,
        currency_id: 'ARS' as const
      })
    }
    
    if (discount > 0 && coupon) {
      mpItems.push({
        id: 'discount',
        title: `Descuento - ${coupon.code}`,
        description: coupon.type === 'percentage'
          ? `${coupon.discount}% OFF`
          : `$${coupon.discount} ARS OFF`,
        category_id: 'discount',
        quantity: 1,
        unit_price: -discount,
        currency_id: 'ARS' as const
      })
    }
    
    const preferenceData = {
      items: mpItems,
      payer: shippingAddress ? {
        name: shippingAddress.firstName || shippingAddress.name || '',
        surname: shippingAddress.lastName || '',
        email: userEmail,
        phone: {
          area_code: shippingAddress.phone?.substring(0, 4) || '353',
          number: shippingAddress.phone?.replace(/[\s\-\(\)]/g, '') || ''
        },
        address: {
          street_name: shippingAddress.address || '',
          street_number: shippingAddress.addressNumber || '0',
          zip_code: shippingAddress.postalCode || ''
        }
      } : {
        email: userEmail
      },
      back_urls: {
        success: `${process.env.NEXT_PUBLIC_SITE_URL}/orden-confirmada?orderId=${order.id}`,
        failure: `${process.env.NEXT_PUBLIC_SITE_URL}/pago-fallido?orderId=${order.id}`,
        pending: `${process.env.NEXT_PUBLIC_SITE_URL}/pago-pendiente?orderId=${order.id}`
      },
      auto_return: 'approved' as const,
      payment_methods: {
        excluded_payment_methods: [],
        excluded_payment_types: [],
        installments: 12,
        default_installments: 3
      },
      notification_url: `${process.env.NEXT_PUBLIC_SITE_URL}/api/webhooks/mercadopago`,
      external_reference: order.id,
      statement_descriptor: 'AZUL COLCHONES',
      binary_mode: false,
      expires: true,
      expiration_date_from: new Date().toISOString(),
      expiration_date_to: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    }
    
    const response = await preference.create({ body: preferenceData })
    
    if (!response.id || !response.init_point) {
      throw new Error('Invalid MercadoPago response')
    }
    
    if (!isValidMercadoPagoUrl(response.init_point)) {
      throw new Error('Invalid redirect URL from MercadoPago')
    }
    
    await prisma.order.update({
      where: { id: order.id },
      data: {
        mercadoPagoPreferenceId: response.id
      }
    })
    
    const duration = Date.now() - startTime
    
    console.log('‚úÖ Preferencia creada:', response.id, `(${duration}ms)`)
    
    return NextResponse.json({
      success: true,
      orderId: order.id,
      preferenceId: response.id,
      initPoint: response.init_point,
      sandboxInitPoint: response.sandbox_init_point,
      _meta: {
        duration,
        method: 'mercadopago',
        total,
        items: mpItems.length
      }
    }, {
      headers: {
        'X-Response-Time': `${duration}ms`,
        'Cache-Control': 'no-store'
      }
    })
    
  } catch (error) {
    console.error('‚ùå Error en checkout:', error)
    
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        {
          error: 'Datos inv√°lidos',
          details: error.errors.map(e => ({
            field: e.path.join('.'),
            message: e.message
          }))
        },
        { status: 400 }
      )
    }
    
    if (error instanceof Error && error.message.includes('MercadoPago')) {
      return NextResponse.json(
        {
          error: 'Error al procesar el pago con MercadoPago',
          details: error.message
        },
        { status: 500 }
      )
    }
    
    return NextResponse.json(
      {
        error: 'No se pudo crear la sesi√≥n de pago',
        message: 'Por favor intent√° de nuevo o contact√° a soporte'
      },
      { status: 500 }
    )
  }
}

// ============================================================================
// GET ENDPOINT
// ============================================================================

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  const preferenceId = searchParams.get('preference_id')
  
  if (!preferenceId) {
    return NextResponse.json({
      status: 'ok',
      timestamp: new Date().toISOString(),
      mercadopago: !!process.env.MERCADOPAGO_ACCESS_TOKEN,
      rateLimit: {
        maxPerHour: MAX_REQUESTS_PER_HOUR,
        activeConnections: requestCounts.size
      }
    })
  }
  
  try {
    if (!preference) {
      return NextResponse.json(
        { error: 'Sistema de pago no configurado' },
        { status: 503 }
      )
    }
    
    const response = await preference.get({ preferenceId })
    
    return NextResponse.json({
      id: response.id,
      items: response.items,
      payer: response.payer,
      date_created: response.date_created
    })
    
  } catch (error) {
    console.error('‚ùå Error obteniendo preferencia:', error)
    return NextResponse.json(
      { error: 'No se pudo obtener la preferencia' },
      { status: 500 }
    )
  }
}