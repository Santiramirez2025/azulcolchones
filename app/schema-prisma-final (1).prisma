// ============================================================================
// PRISMA SCHEMA - AZUL COLCHONES ‚úÖ OPTIMIZADO CON STOCK REAL
// ============================================================================
// üÜï MEJORAS:
// - ProductVariant con isActive para control de disponibilidad
// - Relaci√≥n bidireccional Product <-> ProductVariant
// - √çndices optimizados para queries de stock
// - Campo stock en variantes para control individual
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// PRODUCT MODEL - ‚úÖ COMPLETO
// ============================================================================
model Product {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  subtitle        String
  description     String
  
  // ============================================================================
  // PRICING - Todos los precios en CENTAVOS (multiplicar por 100)
  // ============================================================================
  price           Int                              // Precio base en centavos
  originalPrice   Int?                             // Precio antes de descuento
  compareAtPrice  Int?                             // Precio de comparaci√≥n
  discount        Int?                             // Porcentaje de descuento (0-100)
  
  // ============================================================================
  // INVENTORY & STOCK
  // ============================================================================
  stock           Int               @default(0)    // Stock total (calculado desde variantes)
  inStock         Boolean           @default(true)
  lowStockAlert   Int               @default(5)
  
  // ============================================================================
  // CATEGORIZATION
  // ============================================================================
  category        String
  subcategory     String?
  tags            String[]
  
  // ============================================================================
  // MEDIA
  // ============================================================================
  images          String[]                         // Array de URLs de im√°genes
  image           String?                          // Imagen principal (para compatibilidad)
  
  // ============================================================================
  // PRODUCT SPECIFICATIONS
  // ============================================================================
  firmness        String?                          // BLANDO, MEDIO, FIRME, etc.
  firmnessValue   Int               @default(70)   // 0-100 (para ordenamiento)
  height          Int               @default(25)   // Altura en cm
  weight          Int?                             // Peso en kg
  
  // ============================================================================
  // COMMERCIAL TERMS
  // ============================================================================
  warranty        Int               @default(5)    // A√±os de garant√≠a
  trialNights     Int               @default(100)  // Noches de prueba
  
  // ============================================================================
  // FEATURES & DESCRIPTIONS
  // ============================================================================
  features        String[]                         // Caracter√≠sticas principales
  techFeatures    String[]                         // Caracter√≠sticas t√©cnicas
  highlights      String[]                         // Puntos destacados
  materials       String[]                         // Materiales utilizados
  layers          Json?                            // Estructura de capas (JSON)
  certifications  String[]                         // Certificaciones
  story           String?                          // Historia/descripci√≥n del producto
  
  // ============================================================================
  // PRODUCT ATTRIBUTES - BOOLEAN FLAGS
  // ============================================================================
  cooling         Boolean           @default(false) // Sistema de enfriamiento
  isEco           Boolean           @default(false) // Producto ecol√≥gico
  hypoallergenic  Boolean           @default(true)  // Hipoalerg√©nico
  washable        Boolean           @default(false) // Lavable
  includesBase    Boolean           @default(false) // Incluye base/sommier
  isPremium       Boolean           @default(false) // Producto premium
  antiMite        Boolean           @default(false) // Anti-√°caros
  pillowTop       Boolean           @default(false) // Pillow top
  
  // ============================================================================
  // RATINGS & REVIEWS
  // ============================================================================
  transpirability Int               @default(80)    // 0-100
  satisfaction    Int               @default(95)    // 0-100
  rating          Float             @default(4.8)   // 0-5
  reviewCount     Int               @default(0)
  
  // ============================================================================
  // PRODUCT STATUS FLAGS
  // ============================================================================
  isActive        Boolean           @default(true)
  isFeatured      Boolean           @default(false)
  isBestSeller    Boolean           @default(false)
  isNew           Boolean           @default(false)
  badge           String?                          // Badge del producto (NUEVO, BESTSELLER, etc)
  
  // ============================================================================
  // LOGISTICS & SHIPPING
  // ============================================================================
  shippingCost    Int               @default(0)     // Costo env√≠o en centavos
  sku             String?           @unique         // SKU del producto principal
  
  // ============================================================================
  // DISPLAY & DESIGN
  // ============================================================================
  mainColor       String?           @default("#3b82f6") // Color principal (hex)
  gradient        String?                          // Gradiente para el card
  
  // ============================================================================
  // SEO METADATA
  // ============================================================================
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]
  
  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // ============================================================================
  // RELATIONS
  // ============================================================================
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reviews         Review[]
  variants        ProductVariant[]  // ‚≠ê Relaci√≥n con variantes

  // ============================================================================
  // INDEXES - Optimizaci√≥n de queries
  // ============================================================================
  @@index([slug])
  @@index([category])
  @@index([isActive])
  @@index([isBestSeller])
  @@index([price])
  @@index([sku])
  @@index([createdAt])
}

// ============================================================================
// PRODUCT VARIANT MODEL - ‚úÖ OPTIMIZADO PARA STOCK REAL
// ============================================================================
model ProductVariant {
  id            String   @id @default(cuid())
  
  // ‚≠ê RELACI√ìN CON PRODUCTO
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // ‚≠ê IDENTIFICACI√ìN
  sku           String   @unique
  
  // ‚≠ê MEDIDAS
  size          String                             // "1 plaza", "2 plazas", "Queen", "King"
  dimensions    String                             // "190x80", "190x140", "200x160", etc.
  width         Int                                // Ancho en cm
  length        Int                                // Largo en cm
  height        Int                                // Alto en cm
  weight        Int?                               // Peso en kg
  
  // ‚≠ê PRICING - En centavos
  price         Int                                // Precio espec√≠fico de esta variante
  originalPrice Int?                               // Precio original en centavos
  
  // ‚≠ê STOCK - CR√çTICO PARA EL SELECTOR
  stock         Int      @default(0)               // Stock individual de esta medida
  inStock       Boolean  @default(true)            // Flag de disponibilidad
  
  // ‚≠ê CONTROL DE DISPONIBILIDAD
  isActive      Boolean  @default(true)            // Si est√° disponible para venta
  isDefault     Boolean  @default(false)           // Variante por defecto (se muestra primero)
  
  // ‚≠ê TIMESTAMPS
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // ‚≠ê RELACIONES
  cartItems     CartItem[]
  orderItems    OrderItem[]

  // ‚≠ê INDEXES - Para queries optimizadas
  @@index([productId])                             // Buscar por producto
  @@index([sku])                                   // Buscar por SKU
  @@index([size])                                  // Filtrar por tama√±o
  @@index([stock])                                 // Filtrar por stock
  @@index([isActive])                              // Solo activas
  @@unique([productId, dimensions])                // No duplicar medidas por producto
}

// ============================================================================
// USER MODEL
// ============================================================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String    @default("Argentina")
  emailVerified DateTime?
  image         String?
  role          String    @default("user")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  cart          Cart?
  orders        Order[]
  reviews       Review[]

  @@index([email])
}

// ============================================================================
// ORDER MODEL
// ============================================================================
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  customerName    String
  customerEmail   String
  customerPhone   String?
  shippingAddress Json
  paymentMethod   String
  paymentStatus   String      @default("pending")
  paymentId       String?
  subtotal        Int                              // En centavos
  discount        Int         @default(0)          // En centavos
  shipping        Int         @default(0)          // En centavos
  total           Int                              // En centavos
  status          String      @default("pending")
  trackingNumber  String?
  carrier         String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deliveredAt     DateTime?
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// ORDER ITEM MODEL - ‚≠ê ACTUALIZADO CON VARIANTE
// ============================================================================
model OrderItem {
  id         String          @id @default(cuid())
  orderId    String
  productId  String
  variantId  String?                              // ‚≠ê Referencia a la variante comprada
  quantity   Int
  price      Int                                  // Precio en centavos
  size       String?                              // Medida comprada
  color      String?
  order      Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product         @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])                           // ‚≠ê √çndice para variante
}

// ============================================================================
// CART MODEL
// ============================================================================
model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
}

// ============================================================================
// CART ITEM MODEL - ‚≠ê ACTUALIZADO CON VARIANTE
// ============================================================================
model CartItem {
  id        String          @id @default(cuid())
  cartId    String
  productId String
  variantId String?                              // ‚≠ê Referencia a la variante
  quantity  Int             @default(1)
  size      String?
  color     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, productId, variantId])       // ‚≠ê Unique por variante
  @@index([cartId])
  @@index([productId])
  @@index([variantId])                           // ‚≠ê √çndice para variante
}

// ============================================================================
// REVIEW MODEL
// ============================================================================
model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int                                    // 1-5
  title     String?
  comment   String
  verified  Boolean  @default(false)              // Compra verificada
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
}

// ============================================================================
// COUPON MODEL
// ============================================================================
model Coupon {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  type        String                               // percentage, fixed
  value       Int                                  // Porcentaje o monto en centavos
  minPurchase Int?                                 // Compra m√≠nima en centavos
  maxUses     Int?
  usedCount   Int       @default(0)
  isActive    Boolean   @default(true)
  startsAt    DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
}

// ============================================================================
// NEWSLETTER MODEL
// ============================================================================
model Newsletter {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([email])
}

// ============================================================================
// NOTAS IMPORTANTES PARA MIGRACI√ìN
// ============================================================================
/*

CAMBIOS PRINCIPALES vs SCHEMA ANTERIOR:

1. ‚úÖ ProductVariant.isActive agregado
   - Permite activar/desactivar variantes sin borrarlas
   - √ötil para productos temporalmente agotados

2. ‚úÖ CartItem y OrderItem con variantId
   - Ahora se guarda exactamente qu√© variante se compr√≥/agreg√≥
   - Permite tracking preciso de ventas por medida

3. ‚úÖ √çndices optimizados
   - @@index([stock]) en ProductVariant
   - @@index([isActive]) en ProductVariant
   - @@index([variantId]) en CartItem y OrderItem

4. ‚úÖ Unique constraint mejorado
   - @@unique([productId, dimensions]) evita duplicados
   - @@unique([cartId, productId, variantId]) en CartItem

PARA MIGRAR DESDE TU SCHEMA ACTUAL:

npx prisma migrate dev --name add-variant-tracking

Esto crear√° la migraci√≥n que:
- Agrega isActive a ProductVariant
- Agrega variantId a CartItem y OrderItem
- Crea los √≠ndices nuevos
- Actualiza constraints

*/
