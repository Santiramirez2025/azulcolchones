// ============================================================================
// PRISMA SCHEMA - AZUL COLCHONES ✅ CORREGIDO
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
}
// ============================================================================
// PRODUCT MODEL
// ============================================================================
model Product {
  id              String            @id @default(cuid())
  name            String
  slug            String            @unique
  subtitle        String
  description     String
  
  // Pricing (en centavos)
  price           Int
  originalPrice   Int?
  compareAtPrice  Int?
  discount        Int?
  
  // Inventory
  stock           Int               @default(0)
  inStock         Boolean           @default(true)
  lowStockAlert   Int               @default(5)
  
  // Categorization
  category        String
  subcategory     String?
  tags            String[]
  
  // Media
  images          String[]
  image           String?
  
  // Specifications
  firmness        String?
  firmnessValue   Int               @default(70)
  height          Int               @default(25)
  weight          Int?
  
  // Commercial terms
  warranty        Int               @default(5)
  trialNights     Int               @default(100)
  
  // Features
  features        String[]
  techFeatures    String[]
  highlights      String[]
  materials       String[]
  layers          Json?
  certifications  String[]
  story           String?
  
  // Attributes
  cooling         Boolean           @default(false)
  isEco           Boolean           @default(false)
  hypoallergenic  Boolean           @default(true)
  washable        Boolean           @default(false)
  includesBase    Boolean           @default(false)
  isPremium       Boolean           @default(false)
  antiMite        Boolean           @default(false)
  pillowTop       Boolean           @default(false)
  
  // Ratings
  transpirability Int               @default(80)
  satisfaction    Int               @default(95)
  rating          Float             @default(4.8)
  reviewCount     Int               @default(0)
  
  // Status
  isActive        Boolean           @default(true)
  isFeatured      Boolean           @default(false)
  isBestSeller    Boolean           @default(false)
  isNew           Boolean           @default(false)
  badge           String?
  
  // Logistics
  shippingCost    Int               @default(0)
  sku             String?           @unique
  
  // Display
  mainColor       String?           @default("#3b82f6")
  gradient        String?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String[]
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reviews         Review[]
  variants        ProductVariant[]

  @@index([slug])
  @@index([category])
  @@index([isActive])
  @@index([isBestSeller])
  @@index([price])
  @@index([sku])
  @@index([createdAt])
}

// ============================================================================
// PRODUCT VARIANT MODEL - ✅ CORREGIDO
// ============================================================================
model ProductVariant {
  id            String   @id @default(cuid())
  
  // Relación
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Identificación
  sku           String   @unique
  
  // Medidas
  size          String
  dimensions    String
  width         Int
  length        Int
  height        Int
  weight        Int?
  
  // Pricing (en centavos)
  price         Int
  originalPrice Int?
  
  // Stock
  stock         Int      @default(0)
  inStock       Boolean  @default(true)
  
  // Control
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  cartItems     CartItem[]
  orderItems    OrderItem[]

  // ✅ CORREGIDO: Solo un unique constraint
  @@unique([productId, dimensions])
  @@index([productId])
  @@index([sku])
  @@index([size])
  @@index([stock])
  @@index([isActive])
}

// ============================================================================
// USER MODEL
// ============================================================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String    @default("Argentina")
  emailVerified DateTime?
  image         String?
  role          String    @default("user")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  cart          Cart?
  orders        Order[]
  reviews       Review[]

  @@index([email])
}

// ============================================================================
// ORDER MODEL
// ============================================================================
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  customerName    String
  customerEmail   String
  customerPhone   String?
  shippingAddress Json
  paymentMethod   String
  paymentStatus   String      @default("pending")
  paymentId       String?
  subtotal        Int
  discount        Int         @default(0)
  shipping        Int         @default(0)
  total           Int
  status          String      @default("pending")
  trackingNumber  String?
  carrier         String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deliveredAt     DateTime?
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// ORDER ITEM MODEL
// ============================================================================
model OrderItem {
  id         String          @id @default(cuid())
  orderId    String
  productId  String
  variantId  String?
  quantity   Int
  price      Int
  size       String?
  color      String?
  order      Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product         @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

// ============================================================================
// CART MODEL
// ============================================================================
model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
}

// ============================================================================
// CART ITEM MODEL
// ============================================================================
model CartItem {
  id        String          @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int             @default(1)
  size      String?
  color     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@index([variantId])
}

// ============================================================================
// REVIEW MODEL
// ============================================================================
model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int
  title     String?
  comment   String
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
}

// ============================================================================
// COUPON MODEL
// ============================================================================
model Coupon {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  type        String
  value       Int
  minPurchase Int?
  maxUses     Int?
  usedCount   Int       @default(0)
  isActive    Boolean   @default(true)
  startsAt    DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
}

// ============================================================================
// NEWSLETTER MODEL
// ============================================================================
model Newsletter {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([email])
}